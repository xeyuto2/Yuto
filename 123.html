<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Our Romantic Lounge üíñ</title>
  <meta name="description" content="A dreamy love lounge for my sweetheart, with realtime chat, notes, games, doodles, gifts, and our special song." />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --rose:#ff4d8d; --rose-2:#ff7ab3; --violet:#8146ff; --night:#0b0718; --glass:rgba(255,255,255,.08);
      --ink:#141323; --text:#ffffff; --soft:#fef3f8; --gold:#ffd166; --mint:#aef0dc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;color:var(--text);background: radial-gradient(1200px 700px at 50% -10%, #ff7ab33a 0%, transparent 60%), linear-gradient(120deg,#1b1433,#291a62 45%,#0e0a22); font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}

    .container{max-width:1180px;margin:0 auto;padding:22px}
    .glass{background:var(--glass);backdrop-filter: blur(10px); border:1px solid #ffffff18; box-shadow: 0 10px 30px #00000060; border-radius:26px}

    /* Header */
    header{position:relative;z-index:2;padding:36px 16px 10px}
    .title{font-family:'Dancing Script', cursive; font-size: clamp(40px, 7vw, 82px); text-align:center; line-height:1.1; letter-spacing:.5px}
    .title .grad{background:linear-gradient(135deg, var(--rose), var(--violet));-webkit-background-clip:text;background-clip:text;color:transparent}
    .subtitle{text-align:center;opacity:.9;margin-top:6px;font-size:clamp(14px,2vw,18px)}

    /* Floating hearts */
    .hearts{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
    .heart{position:absolute;opacity:.7;animation:floatUp linear infinite;filter: drop-shadow(0 6px 12px #ff3d6e66)}
    @keyframes floatUp{0%{transform:translateY(100vh) scale(.7) rotate(0)}100%{transform:translateY(-10vh) scale(1.1) rotate(360deg)}}

    /* Controls bar */
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin-top:14px}
    .input{padding:12px 14px;border-radius:14px;border:1px solid #ffffff2a;background:#ffffff12;color:#fff;min-width:190px}
    .btn{cursor:pointer;border:none;padding:12px 18px;border-radius:999px;font-weight:700;color:#fff;box-shadow:0 10px 24px #00000055;transition:transform .1s ease}
    .btn:active{transform:translateY(1px)}
    .btn-heart{background:radial-gradient(120% 120% at 30% 20%, var(--rose), var(--violet)); position:relative}
    .btn-ghost{background:transparent;border:1px solid #ffffff3a}
    .pill{border-radius:999px;padding:.3rem .7rem;background:#ffffff15;border:1px solid #ffffff2a}

    /* Layout */
    section{position:relative;z-index:1;margin:18px auto;padding:20px}
    .grid{display:grid;gap:18px}
    @media(min-width:1100px){.grid-2{grid-template-columns:1.1fr .9fr}}

    /* Chat */
    .chat-wrap{display:flex;flex-direction:column;height:560px}
    .chat-log{flex:1;overflow:auto;padding:14px;border-radius:20px;background:#ffffff10;border:1px solid #ffffff28}
    .bubble{max-width:78%;margin:10px 0;padding:10px 13px;border-radius:18px 18px 10px 18px;background:#fff;color:#2b2436;box-shadow:0 6px 14px #00000030;position:relative}
    .mine{margin-left:auto;border-radius:18px 18px 18px 10px;background:linear-gradient(135deg,#ff6fb5,#ff3d6e);color:#fff}
    .meta{font-size:11px;opacity:.85;margin-top:6px;display:flex;gap:8px;align-items:center}
    .tick{font-size:13px;opacity:.9}
    .typing{font-size:12px;opacity:.9;margin:6px 6px 0;color:#ffd6ea}
    .chat-input{display:flex;gap:10px;margin-top:10px;align-items:center}
    .chat-input input{flex:1}
    .emoji-bar{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .sticker-btn{font-size:20px}

    /* Notes */
    .notes{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:14px}
    .note{background:#fff;color:#1c1830;padding:16px;border-radius:16px;box-shadow:0 14px 24px #00000040;transform:rotate(var(--rot));position:relative}
    .note h4{margin:0 0 6px;font-family:'Dancing Script',cursive;font-size:26px;color:#e91e63}
    .note small{opacity:.6}

    /* Games */
    .games{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .card{padding:16px;border:1px solid #ffffff2a;border-radius:18px;background:#ffffff10}
    .ttt{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .cell{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;font-size:42px;border-radius:16px;border:1px solid #ffffff40;background:#ffffff12;cursor:pointer;user-select:none;transition:transform .08s}
    .cell:active{transform:scale(.98)}
    /* Connect 4 */
    .c4{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .c4cell{aspect-ratio:1/1;border-radius:50%;background:#ffffff18;border:1px solid #ffffff40;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer}

    /* RPS */
    .rps-choices{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .rps-choices button{border-radius:14px;border:1px solid #ffffff33;background:#ffffff12;color:#fff;padding:10px 14px}

    /* Doodle */
    .board{background:#0e0a22;border:1px solid #ffffff30;border-radius:14px}

    /* Sticker/Gift Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.show{display:flex}
    .gift{background:#0f0a24;border:1px solid #ffffff2a;border-radius:22px;padding:18px;max-width:520px;width:92%;text-align:center;box-shadow:0 30px 60px #00000080}
    .gift h3{margin:6px 0 10px;font-family:'Dancing Script',cursive;font-size:38px}
    .stickerStage{height:260px;display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:16px;background:linear-gradient(145deg,#1c1336,#2a1f56)}

    /* Animated built-in stickers */
    .pulse-heart{width:120px;height:120px;position:relative}
    .pulse-heart:before, .pulse-heart:after{content:"";position:absolute;inset:0;background:radial-gradient(circle at 30% 30%, #ff9ac5, #ff3d6e);border-radius:20px 20px 0 0;transform:rotate(45deg);}
    .pulse-heart:after{transform:rotate(45deg) translate(0, 30%)}
    .pulse-heart{animation:pulse 1.2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

    .rose{position:relative;width:120px;height:120px}
    .rose .petal{position:absolute;left:50%;top:50%;width:18px;height:34px;background:linear-gradient(#ff5fa2,#c71f60);border-radius:18px 18px 0 18px;transform-origin:0 100%;animation:petal .9s ease-out forwards}
    .rose .petal:nth-child(1){transform:translate(-50%,-50%) rotate(0deg)}
    .rose .petal:nth-child(2){animation-delay:.1s;transform:translate(-50%,-50%) rotate(30deg)}
    .rose .petal:nth-child(3){animation-delay:.2s;transform:translate(-50%,-50%) rotate(60deg)}
    .rose .petal:nth-child(4){animation-delay:.3s;transform:translate(-50%,-50%) rotate(90deg)}
    @keyframes petal{0%{opacity:0;transform:translate(-50%,-30%) scale(.6) rotate(var(--r,0))}100%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(var(--r,0))}}

    .teddy{font-size:96px;animation:float 1.6s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}

    /* Footer */
    footer{opacity:.85;text-align:center;padding:26px}
    .tiny{font-size:12px;opacity:.75}
  </style>
</head>
<body>
  <!-- background hearts -->
  <div class="hearts" id="hearts"></div>

  <header class="container">
    <div class="glass" style="padding:18px 18px 18px">
      <h1 class="title">Hi <span id="nameTarget">My Love</span> ‚Äî welcome to our <span class="grad">Romantic Lounge</span> üíå</h1>
      <p class="subtitle">Realtime messenger chat, love notes, playful games, doodles, surprise gifts ‚Äî and our song.</p>
      <div class="bar">
        <input id="myName" class="input" placeholder="Your name or nickname" />
        <input id="roomCode" class="input" placeholder="Room code (e.g. LOVE2025)" />
        <button id="joinBtn" class="btn btn-heart">Save & Join</button>
        <button id="personalizeBtn" class="btn btn-ghost">Personalize üíÖ</button>
        <span class="pill">Music: <button id="playSong" class="btn btn-heart" style="padding:8px 14px">‚ñ∂ Play our song</button> <button id="changeSong" class="btn btn-ghost" style="padding:8px 14px">Change</button></span>
      </div>
      <p class="tiny" style="text-align:center;margin-top:6px">Both of you must enter the <b>same Room code</b>. Your name & code stay only on this device.</p>
    </div>
  </header>

  <main class="container grid grid-2">
    <!-- CHAT -->
    <section class="glass">
      <h3 style="margin:0 0 10px">üí¨ Dreamy Chat (Realtime)</h3>
      <div class="chat-wrap">
        <div id="chatLog" class="chat-log"></div>
        <div id="typing" class="typing" style="display:none">Someone is typing‚Ä¶</div>
        <div class="chat-input">
          <button id="stickerOpen" class="btn btn-ghost sticker-btn" title="Send sticker">üíù</button>
          <input id="chatText" class="input" placeholder="Type a sweet message‚Ä¶ (Enter to send)"/>
          <button id="sendBtn" class="btn btn-heart">Send</button>
        </div>
        <div class="emoji-bar" id="emojiBar">
          <button class="btn btn-ghost">üíñ</button>
          <button class="btn btn-ghost">üåπ</button>
          <button class="btn btn-ghost">üòò</button>
          <button class="btn btn-ghost">ü•∞</button>
          <button class="btn btn-ghost">ü§ó</button>
          <button class="btn btn-ghost">‚ú®</button>
        </div>
      </div>
      <p class="tiny" style="margin-top:8px">Tip: blue ticks mean your love has seen the message.</p>
    </section>

    <!-- LOVE NOTES WALL -->
    <section class="glass">
      <h3 style="margin:0 0 10px">üíå Love Notes Wall</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <input id="noteTitle" class="input" placeholder="Title (e.g., To my moon)" style="flex:1"/>
        <input id="noteText" class="input" placeholder="Write a short lovely note‚Ä¶" style="flex:2"/>
        <button id="addNote" class="btn btn-heart">Post</button>
      </div>
      <div id="notes" class="notes"></div>
    </section>

    <!-- GAMES -->
    <section class="glass" style="grid-column:1/-1">
      <h3 style="margin:0 0 10px">üéÆ Play Together</h3>
      <div class="games">
        <div class="card">
          <h4 style="margin:6px 0">Tic-Tac-Toe ‚Äî Hearts vs Roses</h4>
          <div id="tttYouAre" class="tiny">Joining‚Ä¶</div>
          <div id="tttGrid" class="ttt"></div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap">
            <button id="tttReset" class="btn btn-ghost">Reset</button>
            <span id="tttStatus" class="tiny"></span>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:6px 0">Rock-Paper-Scissors ‚Äî üíñ ‚ú® üåπ</h4>
          <div class="rps-choices">
            <button data-pick="rock">üíñ Rock</button>
            <button data-pick="paper">‚ú® Paper</button>
            <button data-pick="scissors">üåπ Scissors</button>
          </div>
          <div id="rpsInfo" class="tiny" style="margin-top:8px">Make a pick‚Ä¶</div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="rpsReset" class="btn btn-ghost">Reset Round</button>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:6px 0">Connect 4 ‚Äî üíï vs üíú</h4>
          <div id="c4YouAre" class="tiny">Joining‚Ä¶</div>
          <div id="c4Grid" class="c4"></div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap">
            <button id="c4Reset" class="btn btn-ghost">Reset</button>
            <span id="c4Status" class="tiny"></span>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:6px 0">Doodle Board ‚Äî draw hearts together üé®</h4>
          <canvas id="board" class="board" width="520" height="320"></canvas>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button id="clearBoard" class="btn btn-ghost">Clear</button>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:6px 0">Love Quiz ‚ù§Ô∏è</h4>
          <div id="quizQ" class="tiny">Waiting for a question‚Ä¶</div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <input id="quizInput" class="input" placeholder="Type your answer" />
            <button id="quizSend" class="btn btn-heart">Send</button>
            <button id="quizNew" class="btn btn-ghost">New Q</button>
          </div>
          <div id="quizInfo" class="tiny" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- SURPRISE GIFTS -->
    <section class="glass" style="grid-column:1/-1;text-align:center">
      <h3 style="margin:0 0 10px">üéÅ Surprise Gift Box</h3>
      <p class="tiny" style="margin-top:-4px">Click for a sweet animated sticker surprise!</p>
      <button id="giftBtn" class="btn btn-heart" style="font-size:18px;padding:14px 22px">Open a Surprise ‚ú®</button>
    </section>
  </main>

  <footer>
    <p class="tiny">Made with ‚ù§Ô∏è just for <span id="footerName">you</span>. <span id="year"></span></p>
  </footer>

  <!-- Modal for gifts -->
  <div id="giftModal" class="modal">
    <div class="gift">
      <h3 id="giftTitle">A little surprise for you üíù</h3>
      <div class="stickerStage" id="stickerStage"></div>
      <p id="giftCaption" style="margin:10px 0 12px"></p>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button id="anotherGift" class="btn btn-heart">Another one!</button>
        <button id="closeGift" class="btn btn-ghost">Close</button>
      </div>
    </div>
  </div>

  <!-- Music: YouTube iframe player -->
  <div style="position:fixed;bottom:16px;right:16px;z-index:60" class="glass">
    <div id="ytWrap" style="width:320px;height:180px;">
      <iframe id="yt" width="320" height="180" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
  </div>

  <!-- Firebase (Compat SDK for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- YouTube Iframe API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // ======= üîß PASTE YOUR FIREBASE CONFIG HERE =======
    // To get your Firebase config:
    // 1. Go to https://console.firebase.google.com/
    // 2. Create a new project or select an existing one
    // 3. Go to Project Settings > General > Your apps
    // 4. Add a web app, then copy the firebaseConfig object
    // 5. Paste it below
    // Example:
    // const firebaseConfig = {
    //   apiKey: "your-api-key",
    //   authDomain: "your-project.firebaseapp.com",
    //   databaseURL: "https://your-project-default-rtdb.firebaseio.com",
    //   projectId: "your-project",
    //   storageBucket: "your-project.appspot.com",
    //   messagingSenderId: "your-messaging-sender-id",
    //   appId: "your-app-id"
    // };
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "",
      appId: ""
    };
    // Set Firebase Realtime Database rules in the Firebase Console to secure data:
    // {
    //   "rules": {
    //     "rooms": {
    //       "$roomId": {
    //         ".read": "true",
    //         ".write": "true",
    //         "presence": {
    //           "$uid": {
    //             ".read": "true",
    //             ".write": "auth != null || true"
    //           }
    //         },
    //         "chat": {
    //           ".read": "true",
    //           ".write": "true"
    //         },
    //         "notes": {
    //           ".read": "true",
    //           ".write": "true"
    //         },
    //         "ttt": {
    //           ".read": "true",
    //           ".write": "true"
    //         },
    //         "rps": {
    //           ".read": "true",
    //           ".write": "true"
    //         },
    //         "c4": {
    //           ".read": "true",
    //           ".write": "true"
    //         },
    //         "board": {
    //           ".read": "true",
    //           ".write": "true"
    //         },
    //         "quiz": {
    //           ".read": "true",
    //           ".write": "true"
    //         }
    //       }
    //     }
    //   }
    // }
    // ================================================

    let app, db;
    try {
      app = firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (e) {
      alert('Firebase not initialized. Please paste a valid Firebase config in the code and reload.');
      console.error('Firebase initialization error:', e);
    }

    // ===== Personalization & Music
    const DEFAULT_SONG = 'https://youtu.be/Te_oVpnom-s'; // "Aye Khuda" by Fahad Babar Ali
    const STORAGE = { name: 'love:name', music: 'love:music', myName: 'love:myName', room: 'love:room', client: 'love:client' };
    const nameTarget = document.getElementById('nameTarget');
    const footerName = document.getElementById('footerName');
    const personalBtn = document.getElementById('personalizeBtn');
    const playBtn = document.getElementById('playSong');
    const changeBtn = document.getElementById('changeSong');
    let ytPlayer = null;
    let ytReady = false;

    function onYouTubeIframeAPIReady() {
      try {
        ytPlayer = new YT.Player('yt', {
          height: '180',
          width: '320',
          videoId: getYouTubeVideoId(localStorage.getItem(STORAGE.music) || DEFAULT_SONG),
          playerVars: {
            autoplay: 0,
            controls: 1,
            rel: 0,
            showinfo: 0
          },
          events: {
            onReady: () => {
              ytReady = true;
              console.log('YouTube player ready');
            },
            onError: (e) => {
              console.error('YouTube player error:', e);
              alert('Error loading "Aye Khuda". Please check your internet connection or try again.');
            }
          }
        });
      } catch (e) {
        console.error('Failed to initialize YouTube player:', e);
        alert('Failed to load the music player. Please ensure the YouTube link is valid and try again.');
      }
    }

    function getYouTubeVideoId(url) {
      try {
        let id = '';
        if (!url) return 'Te_oVpnom-s'; // Fallback to "Aye Khuda"
        if (url.includes('youtube.com/watch')) {
          const u = new URL(url);
          id = u.searchParams.get('v');
        } else if (url.includes('youtu.be/')) {
          id = url.split('youtu.be/')[1].split(/[?&#]/)[0];
        } else if (url.match(/^[a-zA-Z0-9_-]{11}$/)) {
          id = url; // Direct video ID
        }
        return id || 'Te_oVpnom-s'; // Fallback
      } catch (e) {
        console.error('Error parsing YouTube URL:', e);
        return 'Te_oVpnom-s'; // Fallback
      }
    }

    playBtn.onclick = () => {
      if (!ytReady || !ytPlayer || typeof ytPlayer.playVideo !== 'function') {
        alert('Music player is not ready yet. Please wait a moment or check your internet connection.');
        return;
      }
      try {
        ytPlayer.playVideo();
      } catch (e) {
        console.error('Error playing video:', e);
        alert('Failed to play "Aye Khuda". Please ensure your internet connection is stable.');
      }
    };

    changeBtn.onclick = () => {
      const cur = localStorage.getItem(STORAGE.music) || DEFAULT_SONG;
      const u = prompt('Paste YouTube link to your girlfriend\'s favorite song', cur) || cur;
      if (u) {
        localStorage.setItem(STORAGE.music, u);
        const videoId = getYouTubeVideoId(u);
        if (ytReady && ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
          try {
            ytPlayer.loadVideoById(videoId);
          } catch (e) {
            console.error('Error loading new video:', e);
            alert('Failed to load the new song. Please check the YouTube link.');
          }
        } else {
          // Update iframe src manually if player not ready
          document.getElementById('yt').src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1`;
        }
      }
    };

    personalBtn.onclick = () => {
      const cur = localStorage.getItem(STORAGE.name) || 'My Love';
      const n = prompt("Your girlfriend's name (how you call her)?", cur) || cur;
      if (n) {
        localStorage.setItem(STORAGE.name, n);
        nameTarget.textContent = n;
        footerName.textContent = n;
        confetti();
      }
    };

    (function initPersonal() {
      // Force reset music to ensure "Aye Khuda" loads
      localStorage.removeItem(STORAGE.music);
      const n = localStorage.getItem(STORAGE.name);
      if (n) {
        nameTarget.textContent = n;
        footerName.textContent = n;
      }
      document.getElementById('year').textContent = new Date().getFullYear();
      const saved = localStorage.getItem(STORAGE.music) || DEFAULT_SONG;
      localStorage.setItem(STORAGE.music, saved);
      // Set initial iframe src to "Aye Khuda"
      document.getElementById('yt').src = `https://www.youtube.com/embed/Te_oVpnom-s?enablejsapi=1`;
    })();

    // Hearts background
    const hearts = document.getElementById('hearts');
    function spawnHearts() {
      for (let i = 0; i < 26; i++) {
        const h = document.createElement('div');
        h.className = 'heart';
        const size = 12 + Math.random() * 28;
        h.style.left = Math.random() * 100 + 'vw';
        h.style.animationDuration = 8 + Math.random() * 8 + 's';
        h.style.animationDelay = -Math.random() * 16 + 's';
        h.innerHTML = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="url(#g)"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ff6fb5"/><stop offset="100%" stop-color="#ff3d6e"/></linearGradient></defs><path d="M12 21s-6.716-4.297-9.428-7.01C-1.14 11.571.343 6.857 4.286 6.857 7.09 6.857 8.571 9 12 11.571 15.429 9 16.91 6.857 19.714 6.857c3.943 0 5.426 4.714 1.714 7.133C18.716 16.703 12 21 12 21z"/></svg>`;
        hearts.appendChild(h);
      }
    }
    spawnHearts();

    // Confetti burst
    function confetti() {
      for (let i = 0; i < 70; i++) {
        const p = document.createElement('div');
        const size = 6 + Math.random() * 8;
        p.style.cssText = `position:fixed;left:${Math.random() * 100}vw;top:-10px;width:${size}px;height:${size}px;background:hsl(${Math.random() * 360} 85% 65%);border-radius:2px;transform:rotate(${Math.random() * 360}deg);opacity:.9;z-index:9999;pointer-events:none;`;
        document.body.appendChild(p);
        const dx = (Math.random() * 2 - 1) * 120;
        const dy = 100 + Math.random() * 40;
        const duration = 700 + Math.random() * 600;
        const start = performance.now();
        function tick(t) {
          const k = (t - start) / duration;
          if (k >= 1) {
            p.remove();
            return;
          }
          p.style.transform = `translate(${dx * k}px, ${dy * k}px) rotate(${360 * k}deg)`;
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      }
    }

    // Identity + room join
    const myNameInput = document.getElementById('myName');
    const roomInput = document.getElementById('roomCode');
    const joinBtn = document.getElementById('joinBtn');
    const CLIENT_ID = localStorage.getItem(STORAGE.client) || (() => {
      const id = Math.random().toString(36).slice(2, 10);
      localStorage.setItem(STORAGE.client, id);
      return id;
    })();
    let MY_NAME = localStorage.getItem(STORAGE.myName) || '';
    let ROOM = localStorage.getItem(STORAGE.room) || '';
    let roomRef = null;
    myNameInput.value = MY_NAME;
    roomInput.value = ROOM;

    function joinRoom() {
      MY_NAME = myNameInput.value.trim() || 'Me';
      ROOM = roomInput.value.trim() || 'LOVE';
      localStorage.setItem(STORAGE.myName, MY_NAME);
      localStorage.setItem(STORAGE.room, ROOM);
      if (!db) {
        alert('Please set up a valid Firebase config in the code to enable chat, notes, and games.');
        return;
      }
      roomRef = db.ref('rooms/' + ROOM);
      const presRef = roomRef.child('presence/' + CLIENT_ID);
      presRef.set({ name: MY_NAME, at: firebase.database.ServerValue.TIMESTAMP, lastRead: 0 });
      presRef.onDisconnect().remove();
      initChat();
      initNotes();
      initTTT();
      initRPS();
      initC4();
      initBoard();
      initQuiz();
      confetti();
    }
    joinBtn.addEventListener('click', joinRoom);
    roomInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') joinRoom();
    });
    myNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') joinRoom();
    });
    if (MY_NAME && ROOM && db) {
      joinRoom();
    }

    // Helper to get partner lastRead
    let partnerLastRead = 0;
    let partnerName = 'Love';
    function watchPresence() {
      if (!roomRef) return;
      roomRef.child('presence').on('value', snap => {
        const p = snap.val() || {};
        const ids = Object.keys(p);
        const otherId = ids.find(id => id !== CLIENT_ID);
        if (otherId) {
          partnerLastRead = p[otherId]?.lastRead || 0;
          partnerName = p[otherId]?.name || 'Love';
        }
      });
    }

    // ===== CHAT (typing + read receipts + stickers) =====
    const chatLog = document.getElementById('chatLog');
    const chatText = document.getElementById('chatText');
    const sendBtn = document.getElementById('sendBtn');
    const typingEl = document.getElementById('typing');
    const emojiBar = document.getElementById('emojiBar');
    const stickerOpen = document.getElementById('stickerOpen');
    let typingRef = null, typingTimer = null;
    let lastMsgTS = 0;

    function heartFloat() {
      const e = document.createElement('div');
      e.style.cssText = 'position:fixed;left:50%;bottom:80px;transform:translateX(-50%);font-size:28px;opacity:.95;z-index:30';
      e.textContent = 'üíû';
      document.body.appendChild(e);
      const start = performance.now();
      const dur = 1200;
      function step(t) {
        const k = (t - start) / dur;
        if (k >= 1) {
          e.remove();
          return;
        }
        e.style.transform = `translate(-50%, ${-120 * k}px)`;
        e.style.opacity = String(1 - k);
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function renderMsg(m) {
      const wrap = document.createElement('div');
      const mine = m.senderId === CLIENT_ID;
      wrap.className = 'bubble ' + (mine ? 'mine' : '');
      const who = escapeHtml(m.name || 'Someone');
      const time = new Date(m.ts || Date.now()).toLocaleTimeString();
      let content = '';
      if (m.type === 'sticker') {
        content = `<div style="font-size:44px">${escapeHtml(m.emoji || 'üíñ')}</div>`;
      } else {
        content = `<div>${escapeHtml(m.text || '')}</div>`;
      }
      const ticks = mine ? `<span class='tick' title='Read receipts'>${partnerLastRead && partnerLastRead >= (m.ts || 0) ? '‚úî‚úî' : '‚úî'}</span>` : '';
      wrap.innerHTML = `${content}<div class='meta'>${who} ‚Ä¢ ${time} ${ticks}</div>`;
      chatLog.appendChild(wrap);
      chatLog.scrollTop = chatLog.scrollHeight;
      lastMsgTS = Math.max(lastMsgTS, m.ts || 0);
    }

    function initChat() {
      if (!roomRef) return;
      const listRef = roomRef.child('chat');
      watchPresence();
      const myPres = roomRef.child('presence/' + CLIENT_ID);
      const markRead = () => myPres.update({ lastRead: lastMsgTS || Date.now() });
      setInterval(markRead, 1200);
      chatLog.addEventListener('scroll', markRead);
      listRef.limitToLast(500).on('child_added', snap => {
        const m = snap.val();
        renderMsg(m);
      });
      function send() {
        const text = chatText.value.trim();
        if (!text) return;
        listRef.push({ type: 'text', name: MY_NAME, senderId: CLIENT_ID, text, ts: firebase.database.ServerValue.TIMESTAMP });
        chatText.value = '';
        setTyping(false);
        heartFloat();
      }
      sendBtn.onclick = send;
      chatText.onkeydown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          send();
        }
      };
      emojiBar.querySelectorAll('button').forEach(b => {
        b.onclick = () => {
          chatText.value += b.textContent;
          chatText.focus();
        }
      });
      stickerOpen.onclick = () => {
        const choice = prompt('Send a sticker: type one emoji (e.g. üíñ üåπ üß∏ ‚ú®)');
        if (choice) {
          listRef.push({ type: 'sticker', name: MY_NAME, senderId: CLIENT_ID, emoji: choice, ts: firebase.database.ServerValue.TIMESTAMP });
        }
      };
      typingRef = roomRef.child('typing/' + CLIENT_ID);
      typingRef.onDisconnect().remove();
      function setTyping(state) {
        if (!typingRef) return;
        if (state) {
          typingRef.set({ name: MY_NAME, typing: true, at: firebase.database.ServerValue.TIMESTAMP });
        } else {
          typingRef.remove();
        }
      }
      chatText.addEventListener('input', () => {
        const val = chatText.value.trim();
        if (val) {
          setTyping(true);
          if (typingTimer) clearTimeout(typingTimer);
          typingTimer = setTimeout(() => setTyping(false), 1500);
        } else {
          setTyping(false);
        }
      });
      roomRef.child('typing').on('value', snap => {
        const all = snap.val() || {};
        const others = Object.entries(all).filter(([id]) => id !== CLIENT_ID).map(([, v]) => v && v.name).filter(Boolean);
        if (others.length) {
          typingEl.style.display = 'block';
          typingEl.textContent = (others.length === 1 ? `${others[0]} is typing‚Ä¶` : 'They are typing‚Ä¶');
        } else {
          typingEl.style.display = 'none';
        }
      });
    }

    // ===== LOVE NOTES =====
    const notesEl = document.getElementById('notes');
    const addNoteBtn = document.getElementById('addNote');
    const noteTitle = document.getElementById('noteTitle');
    const noteText = document.getElementById('noteText');
    function renderNotesList(list) {
      notesEl.innerHTML = '';
      Object.entries(list || {}).reverse().forEach(([id, n]) => {
        const d = document.createElement('div');
        d.className = 'note';
        d.style.setProperty('--rot', (Math.random() * .6 - .3) + 'deg');
        d.innerHTML = `<h4>${escapeHtml(n.t || 'Untitled')}</h4><div>${escapeHtml(n.x || '')}</div><small>by ${escapeHtml(n.name || 'someone')} ‚Ä¢ ${new Date(n.ts || Date.now()).toLocaleString()}</small>`;
        notesEl.appendChild(d);
      });
    }
    function initNotes() {
      if (!roomRef) return;
      const ref = roomRef.child('notes');
      ref.on('value', snap => {
        renderNotesList(snap.val());
      });
      addNoteBtn.onclick = () => {
        const t = noteTitle.value.trim();
        const x = noteText.value.trim();
        if (!t && !x) return;
        ref.push({ t, x, name: MY_NAME, by: CLIENT_ID, ts: firebase.database.ServerValue.TIMESTAMP });
        noteText.value = '';
        noteTitle.value = '';
        confetti();
      };
    }

    // ===== TIC TAC TOE =====
    const tttGrid = document.getElementById('tttGrid');
    const tttReset = document.getElementById('tttReset');
    const tttStatus = document.getElementById('tttStatus');
    const tttYouAre = document.getElementById('tttYouAre');
    let myRole = null; // 'x' or 'o'
    function initTTT() {
      if (!roomRef) return;
      const base = roomRef.child('ttt');
      const playersRef = base.child('players');
      const stateRef = base.child('state');
      playersRef.transaction(cur => {
        cur = cur || {};
        if (cur.x !== CLIENT_ID && cur.o !== CLIENT_ID) {
          if (!cur.x) cur.x = CLIENT_ID;
          else if (!cur.o) cur.o = CLIENT_ID;
        }
        return cur;
      }, (err, committed, snap) => {
        const p = snap && snap.val();
        myRole = (p && p.x === CLIENT_ID) ? 'x' : (p && p.o === CLIENT_ID) ? 'o' : null;
        tttYouAre.textContent = myRole ? `You are ${myRole === 'x' ? '‚ù§ (Hearts)' : 'üåπ (Roses)'} ‚Äî ${MY_NAME}` : 'Spectating (waiting for a free slot)';
      });
      stateRef.transaction(cur => {
        if (cur) return cur;
        return { board: Array(9).fill(''), turn: 'x', winner: '', draw: false, updated: firebase.database.ServerValue.TIMESTAMP };
      });
      stateRef.on('value', snap => {
        const s = snap.val();
        if (!s) return;
        drawTTT(s);
      });
      tttGrid.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const c = document.createElement('div');
        c.className = 'cell';
        c.dataset.i = i;
        c.onclick = () => moveTTT(i);
        tttGrid.appendChild(c);
      }
      tttReset.onclick = () => {
        base.set(null);
        initTTT();
      };
      function moveTTT(i) {
        stateRef.transaction(cur => {
          if (!cur) return cur;
          const { board, turn, winner } = cur;
          const sym = myRole;
          if (winner || !sym || sym !== turn || board[i]) return cur;
          const nb = [...board];
          nb[i] = sym;
          const win = winnerTTT(nb);
          const full = nb.every(v => v);
          return { board: nb, turn: sym === 'x' ? 'o' : 'x', winner: win ? sym : '', draw: !win && full, updated: firebase.database.ServerValue.TIMESTAMP };
        });
      }
      function drawTTT(s) {
        const b = s.board || [];
        [...tttGrid.children].forEach((c, idx) => {
          const v = b[idx];
          c.textContent = v ? (v === 'x' ? '‚ù§' : 'üåπ') : '';
        });
        if (s.winner) {
          tttStatus.textContent = (s.winner === myRole) ? 'You won! üéâ' : 'They won! üíñ';
        } else if (s.draw) {
          tttStatus.textContent = 'Draw! ‚òØÔ∏è';
        } else {
          tttStatus.textContent = (myRole === s.turn) ? 'Your turn‚Ä¶' : 'Their turn‚Ä¶';
        }
      }
      function winnerTTT(b) {
        const L = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
        return L.some(([a, c, d]) => b[a] && b[a] === b[c] && b[a] === b[d]);
      }
    }

    // ===== RPS =====
    const rpsWrap = document.querySelector('.rps-choices');
    const rpsInfo = document.getElementById('rpsInfo');
    const rpsReset = document.getElementById('rpsReset');
    function initRPS() {
      if (!roomRef) return;
      const base = roomRef.child('rps');
      const picksRef = base.child('picks');
      const resultRef = base.child('result');
      picksRef.off();
      resultRef.off();
      rpsWrap.querySelectorAll('button').forEach(btn => {
        btn.onclick = () => pick(btn.dataset.pick);
      });
      rpsReset.onclick = () => {
        picksRef.set(null);
        resultRef.set(null);
        rpsInfo.textContent = 'Make a pick‚Ä¶';
      };
      picksRef.on('value', snap => {
        const picks = snap.val() || {};
        const mine = picks[CLIENT_ID];
        const otherId = Object.keys(picks).find(k => k !== CLIENT_ID);
        if (mine) {
          rpsInfo.textContent = `You picked ${label(mine)}. Waiting‚Ä¶`;
        }
        if (mine && otherId && picks[otherId]) {
          if (CLIENT_ID < otherId) {
            const outcome = decide(mine, picks[otherId]);
            resultRef.set({ a: mine, b: picks[otherId], winner: outcome, at: firebase.database.ServerValue.TIMESTAMP });
          }
        }
      });
      resultRef.on('value', snap => {
        const r = snap.val();
        if (!r) return;
        const text = r.winner === 'draw' ? `You ${label(r.a)} vs ${label(r.b)} Them ‚Äî Draw!` : (r.winner === 'a' ? `You ${label(r.a)} beat ${label(r.b)} üéâ` : `They ${label(r.b)} beat ${label(r.a)} üòÖ`);
        rpsInfo.textContent = text;
      });
      function label(x) {
        return x === 'rock' ? 'üíñ Rock' : x === 'paper' ? '‚ú® Paper' : 'üåπ Scissors';
      }
      function pick(choice) {
        picksRef.child(CLIENT_ID).set(choice);
      }
      function decide(a, b) {
        if (a === b) return 'draw';
        if ((a === 'rock' && b === 'scissors') || (a === 'paper' && b === 'rock') || (a === 'scissors' && b === 'paper')) return 'a';
        return 'b';
      }
    }

    // ===== Connect 4 (realtime) =====
    const c4Grid = document.getElementById('c4Grid');
    const c4Reset = document.getElementById('c4Reset');
    const c4Status = document.getElementById('c4Status');
    const c4YouAre = document.getElementById('c4YouAre');
    let c4Role = null; // 'a' or 'b'
    function initC4() {
      if (!roomRef) return;
      const base = roomRef.child('c4');
      const playersRef = base.child('players');
      const stateRef = base.child('state');
      playersRef.transaction(cur => {
        cur = cur || {};
        if (cur.a !== CLIENT_ID && cur.b !== CLIENT_ID) {
          if (!cur.a) cur.a = CLIENT_ID;
          else if (!cur.b) cur.b = CLIENT_ID;
        }
        return cur;
      }, (err, committed, snap) => {
        const p = snap && snap.val();
        c4Role = (p && p.a === CLIENT_ID) ? 'a' : (p && p.b === CLIENT_ID) ? 'b' : null;
        c4YouAre.textContent = c4Role ? `You are ${c4Role === 'a' ? 'üíï' : 'üíú'} ‚Äî ${MY_NAME}` : 'Spectating';
      });
      stateRef.transaction(cur => {
        if (cur) return cur;
        return { cols: Array(7).fill(0).map(() => Array(6).fill('')), turn: 'a', winner: '', updated: firebase.database.ServerValue.TIMESTAMP };
      });
      stateRef.on('value', snap => {
        const s = snap.val();
        if (!s) return;
        drawC4(s);
      });
      c4Grid.innerHTML = '';
      for (let i = 0; i < 42; i++) {
        const d = document.createElement('div');
        d.className = 'c4cell';
        d.onclick = () => dropC4(i % 7);
        c4Grid.appendChild(d);
      }
      c4Reset.onclick = () => {
        base.set(null);
        initC4();
      };
      function dropC4(col) {
        stateRef.transaction(cur => {
          if (!cur) return cur;
          if (cur.winner) return cur;
          if (c4Role !== cur.turn) return cur;
          const colArr = cur.cols[col];
          const row = colArr.lastIndexOf('');
          if (row < 0) return cur;
          colArr[row] = cur.turn;
          const win = winC4(cur.cols);
          return { cols: cur.cols, turn: cur.turn === 'a' ? 'b' : 'a', winner: win ? cur.turn : '', updated: firebase.database.ServerValue.TIMESTAMP };
        });
      }
      function drawC4(s) {
        const flat = [];
        for (let r = 0; r < 6; r++) {
          for (let c = 0; c < 7; c++) {
            flat.push(s.cols[c][r]);
          }
        }
        [...c4Grid.children].forEach((el, idx) => {
          const v = flat[idx];
          el.textContent = v ? (v === 'a' ? 'üíï' : 'üíú') : '';
        });
        c4Status.textContent = s.winner ? ((s.winner === c4Role) ? 'You won! üéâ' : 'They won üíñ') : ((c4Role === s.turn) ? 'Your turn‚Ä¶' : 'Their turn‚Ä¶');
      }
      function winC4(g) {
        const H = 6, W = 7;
        const dirs = [[1, 0], [0, 1], [1, 1], [1, -1]];
        const get = (x, y) => (x >= 0 && y >= 0 && x < W && y < H ? g[x][y] : '');
        for (let x = 0; x < W; x++) {
          for (let y = 0; y < H; y++) {
            const v = get(x, y);
            if (!v) continue;
            for (const [dx, dy] of dirs) {
              if (get(x + dx, y + dy) === v && get(x + 2 * dx, y + 2 * dy) === v && get(x + 3 * dx, y + 3 * dy) === v) return true;
            }
          }
        }
        return false;
      }
    }

    // ===== Doodle Board (realtime) =====
    const board = document.getElementById('board');
    const ctx = board.getContext('2d');
    const clearBoard = document.getElementById('clearBoard');
    function initBoard() {
      if (!roomRef) return;
      const ref = roomRef.child('board');
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#ff6fb5';
      let drawing = false, last = null;
      board.onmousedown = e => {
        drawing = true;
        last = pt(e);
      };
      board.onmouseup = () => drawing = false;
      board.onmouseleave = () => drawing = false;
      board.onmousemove = e => {
        if (!drawing) return;
        const p = pt(e);
        draw(last, p, true);
        last = p;
      };
      function pt(e) {
        const r = board.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      }
      function draw(a, b, emit) {
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.stroke();
        if (emit) {
          ref.push({ a, b, color: '#ff6fb5' });
        }
      }
      ref.limitToLast(1000).on('child_added', snap => {
        const d = snap.val();
        ctx.strokeStyle = d.color || '#ff6fb5';
        draw(d.a, d.b, false);
      });
      clearBoard.onclick = () => {
        ctx.clearRect(0, 0, board.width, board.height);
        ref.set(null);
      };
    }

    // ===== Love Quiz (simple) =====
    const QUIZ = [
      'Our dream vacation?',
      'First movie we watched together?',
      'One word that describes our love?',
      'Favorite dessert?',
      'The song that reminds you of me?'
    ];
    const quizQ = document.getElementById('quizQ');
    const quizInput = document.getElementById('quizInput');
    const quizSend = document.getElementById('quizSend');
    const quizNew = document.getElementById('quizNew');
    const quizInfo = document.getElementById('quizInfo');
    function initQuiz() {
      if (!roomRef) return;
      const base = roomRef.child('quiz');
      const qRef = base.child('q');
      const aRef = base.child('answers');
      quizNew.onclick = () => {
        const q = QUIZ[Math.floor(Math.random() * QUIZ.length)];
        qRef.set({ text: q, at: firebase.database.ServerValue.TIMESTAMP });
        aRef.set(null);
      };
      qRef.on('value', snap => {
        const v = snap.val();
        quizQ.textContent = v ? v.text : 'Click "New Q" to start a love question ‚ô•';
        quizInfo.textContent = '';
      });
      quizSend.onclick = () => {
        const ans = quizInput.value.trim();
        if (!ans) return;
        aRef.child(CLIENT_ID).set({ name: MY_NAME, text: ans, at: firebase.database.ServerValue.TIMESTAMP });
        quizInput.value = '';
      };
      aRef.on('value', snap => {
        const a = snap.val() || {};
        const ids = Object.keys(a);
        if (ids.length >= 2) {
          const [a1, a2] = ids.map(id => a[id].text.toLowerCase());
          quizInfo.textContent = (a1 === a2) ? 'A perfect match! üíû' : 'Cute ‚Äî not the same, but still sweet üíó';
        } else if (ids.length === 1) {
          quizInfo.textContent = 'Waiting for your love to answer‚Ä¶';
        } else {
          quizInfo.textContent = '';
        }
      });
    }

    // ===== Surprise Stickers (built-in & free) =====
    const giftBtn = document.getElementById('giftBtn');
    const giftModal = document.getElementById('giftModal');
    const stickerStage = document.getElementById('stickerStage');
    const giftTitle = document.getElementById('giftTitle');
    const giftCaption = document.getElementById('giftCaption');
    const closeGift = document.getElementById('closeGift');
    const anotherGift = document.getElementById('anotherGift');
    const STICKERS = [
      { type: 'heart', title: 'My heart for you', caption: 'It beats a little faster when I think of you üíì' },
      { type: 'rose', title: 'A rose for my rose', caption: 'You make my world bloom üåπ‚ú®' },
      { type: 'teddy', title: 'A warm hug', caption: 'If I could, I‚Äôd hug you right now üß∏üíû' },
      { type: 'spark', title: 'Starry sparkle', caption: 'You light up my sky ‚ú®' },
    ];
    function showSticker() {
      const s = STICKERS[Math.floor(Math.random() * STICKERS.length)];
      giftTitle.textContent = s.title;
      giftCaption.textContent = s.caption;
      stickerStage.innerHTML = '';
      let el;
      if (s.type === 'heart') {
        el = document.createElement('div');
        el.className = 'pulse-heart';
      } else if (s.type === 'rose') {
        el = document.createElement('div');
        el.className = 'rose';
        for (let i = 1; i <= 4; i++) {
          const p = document.createElement('div');
          p.className = 'petal';
          p.style.setProperty('--r', (i - 1) * 30 + 'deg');
          el.appendChild(p);
        }
      } else if (s.type === 'spark') {
        el = document.createElement('div');
        el.style.fontSize = '80px';
        el.textContent = '‚ú®';
      } else {
        el = document.createElement('div');
        el.className = 'teddy';
        el.textContent = 'üß∏';
      }
      stickerStage.appendChild(el);
      giftModal.classList.add('show');
    }
    giftBtn.onclick = () => { showSticker(); };
    anotherGift.onclick = () => { showSticker(); };
    closeGift.onclick = () => giftModal.classList.remove('show');
    giftModal.addEventListener('click', e => {
      if (e.target === giftModal) giftModal.classList.remove('show');
    });

    // Utils
    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#039;" })[m]);
    }
  </script>
</body>
</html>
